@using MonitoringWeb.WebApp.Data
@using MonitoringSystem.Shared.Data.UsageModel
@using MongoDB.Driver
@using MonitoringSystem.Shared.Services
@using MonitoringWeb.WebApp.Services
@inject UsageService UsageService
@inject ValueChanged<BulkGasType> GasTypeChanged;


<DxGrid Data="@Records" AutoCollapseDetailRow="false" 
        AllowGroup="true" 
        ShowGroupPanel="true"
        CustomizeSummaryDisplayText="Grid_CustomizeSummaryDisplayText"
        PageSize="15"
        PagerPosition="GridPagerPosition.TopAndBottom"
        PageSizeSelectorVisible="true"
        PageSizeSelectorItems="@(new int[] { 5, 10, 15, 20 })"
        PageSizeSelectorAllRowsItemVisible="true"
        PagerSwitchToInputBoxButtonCount="10"
        PagerVisibleNumericButtonCount="10">
    <Columns>
        <DxGridDataColumn FieldName="Date" DisplayFormat="d" />
        <DxGridDataColumn FieldName="DayOfWeek"/>
        <DxGridDataColumn FieldName="DayOfMonth"/>
        <DxGridDataColumn FieldName="WeekOfYear" GroupIndex="2"/>
        <DxGridDataColumn FieldName="MonthName" Caption="Month" GroupIndex="1"/>
        <DxGridDataColumn FieldName="Year" GroupIndex="0"  DisplayFormat="D"/>
        <DxGridDataColumn FieldName="Usage"/>
        <DxGridDataColumn FieldName="PerHour"/>
    </Columns>
    <GroupSummary>
        <DxGridSummaryItem SummaryType="GridSummaryItemType.Avg" FieldName="Usage" Name="PerDay"/>
        <DxGridSummaryItem SummaryType="GridSummaryItemType.Sum" FieldName="Usage" Name="Usage"/>
    </GroupSummary>
</DxGrid>

<DxChart T="UsageDayRecord"
         Data="@Records"
         Width="100%">
    <DxChartTitle Text="Usage">
        <DxChartSubTitle Text="Usage" />
    </DxChartTitle>
    <DxChartLineSeries  Name="By Week"
                        T="UsageDayRecord"
                        TArgument="int"
                        TValue="double"
                        ArgumentField="pasi => pasi.WeekOfYear"
                        ValueField="pasi => pasi.Usage"
                        SummaryMethod="Enumerable.Sum" />
    <DxChartLegend Position="RelativePosition.Outside"
                   HorizontalAlignment="HorizontalAlignment.Center"
                   VerticalAlignment="VerticalEdge.Bottom" />
</DxChart>

@code {
    [Parameter]
    public BulkGasType GasType { get; set; }

    ChartAxisTickInterval interval;
    
    IEnumerable<UsageDayRecord>? Records { get; set; }
    
    void Grid_CustomizeSummaryDisplayText(GridCustomizeSummaryDisplayTextEventArgs e) {
        e.DisplayText = string.Format(e.Item.Name+": {0:N1}", e.Value);
    }

    protected override async Task OnInitializedAsync() {
        this.GasTypeChanged.OnParentChanged += this.OnGasTypeChanged;
        await this.Load();
    }
    
    public override async Task SetParametersAsync(ParameterView parameters) {
        await base.SetParametersAsync(parameters);
        await this.Load();
    }

    private async Task OnGasTypeChanged() {
        await this.Load();
    }

    private async Task Load() {
        switch (this.GasType) {
            case BulkGasType.NH3: {
                this.Records = await this.UsageService.GetNH3Usage();
                break;
            }
            case BulkGasType.H2: {
                this.Records = await this.UsageService.GetH2Usage();
                break;
            }
            case BulkGasType.N2: {
                this.Records = await this.UsageService.GetN2Usage();
                break;
            }
        }
        await InvokeAsync(StateHasChanged);
    }

}