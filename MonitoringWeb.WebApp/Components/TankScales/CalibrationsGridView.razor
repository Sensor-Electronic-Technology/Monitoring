@using MonitoringSystem.Shared.Data.LogModel
@using MonitoringSystem.Shared.Data.EntityDtos
@using MongoDB.Bson
@using MonitoringWeb.WebApp.Services
@inject SelectionChanged<TankScale> TankScaleSelectionChanged;
@implements IAsyncDisposable

<DxGrid Data="@this._calibrations"
                KeyFieldName=""
                ValidationEnabled="false"
                AllowSelectRowByClick="true"
                SelectionMode="GridSelectionMode.Single"
                SelectedDataItem="@this._selectedCalibration"
                SelectedDataItemChanged="SelectedCalChanged"
                EditModelSaving="EditModelSaving"
                PopupEditFormCssClass="pw-800"
                
                EditMode="GridEditMode.EditForm">
            <Columns>
                <DxGridCommandColumn Width="120px" NewButtonVisible="false" DeleteButtonVisible="false"/>
                <DxGridDataColumn FieldName="@nameof(Calibration.CalibrationDate)" />
                <DxGridDataColumn FieldName="@nameof(Calibration.ZeroRawValue)"/>
                <DxGridDataColumn FieldName="@nameof(Calibration.NonZeroRawValue)"/>
                <DxGridDataColumn FieldName="@nameof(Calibration.ZeroValue)"/>
                <DxGridDataColumn FieldName="@nameof(Calibration.NonZeroValue)"/>
                <DxGridDataColumn FieldName="@nameof(Calibration.IsCurrent)"/>
            </Columns>
            <EditFormTemplate Context="EditViewContext">
                @{
                    var cal = (Calibration)EditViewContext.EditModel;
                }
                <DxFormLayout>
                    <DxFormLayoutItem Caption="Raw Zero" ColSpanSm="6">
                        <DxSpinEdit @bind-Value="@cal.ZeroRawValue"></DxSpinEdit>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Raw Non-Zero" ColSpanSm="6">
                        <DxSpinEdit @bind-Value="@cal.ZeroRawValue"></DxSpinEdit>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Actual Zero" ColSpanSm="6">
                        <DxSpinEdit @bind-Value="@cal.ZeroValue"></DxSpinEdit>
                    </DxFormLayoutItem>
                    <DxFormLayoutItem Caption="Actual Non-Zero" ColSpanSm="6">
                        <DxSpinEdit @bind-Value="@cal.NonZeroValue"></DxSpinEdit>
                    </DxFormLayoutItem>
                </DxFormLayout>
            </EditFormTemplate>
        </DxGrid>
@code {
    [Parameter]
    public TankScale? TankScale { get; set; }
    
    private IEnumerable<Calibration> _calibrations;
    private Calibration? _selectedCalibration;

    protected override async Task OnInitializedAsync() {
        this.TankScaleSelectionChanged.OnChanged += this.SelectedScaleChanged;
    }
    
    
    
    private async Task SelectedScaleChanged() {
        this.TankScale = this.TankScaleSelectionChanged.SelectedItem;
        
    }

    private void SelectedCalChanged(Object selection) {
        this._selectedCalibration=selection as Calibration;
        
    }
    
    private async Task EditModelSaving(GridEditModelSavingEventArgs e) {
        if (e.EditModel is Calibration calibration) {
            /*await this.Client.UpdateChannel(channel);
            await this.Update();*/
        }
    }
    public ValueTask DisposeAsync() {
        this.TankScaleSelectionChanged.OnChanged -= this.SelectedScaleChanged;
        return ValueTask.CompletedTask;
    }
}